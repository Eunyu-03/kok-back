<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.kok.mapper.ExperienceNoticeMapper">
    <sql id="search">
        <if test="search.keyword != null">
            and (
                lower(e.experience_notice_title) like concat('%', lower(#{search.keyword}), '%') or
                lower(e.experience_notice_subtitle) like concat('%', lower(#{search.keyword}), '%') or
                lower(e.experience_notice_etc) like concat('%', lower(#{search.keyword}), '%') or
                lower(j.job_name) like concat('%', lower(#{search.keyword}), '%') or
                lower(c.company_name) like concat('%', lower(#{search.keyword}), '%')
            )
        </if>
    </sql>
<!--    조회-->
    <select id="selectAllExperienceNotice">
        select e.id,
        e.experience_notice_title,
        e.experience_notice_subtitle,
        e.experience_notice_etc,
        e.experience_start_date,
        e.experience_end_date,
        e.experience_notice_status,
        e.experience_request_status,
        e.created_datetime,
        e.updated_datetime,
        e.company_id,
        c.company_name,
        s.id as scale_id,
        s.company_scale_name,
        j.job_name,
        count(sv.experience_notice_id) as save_count
        from tbl_experience_notice e
        join tbl_company c on c.user_id=e.company_id
        join tbl_company_scale_category_bridge b on e.company_id = b.company_id
        join tbl_company_scale_category s on b.company_scale_category_id = s.id
        left join tbl_experience_job_category ej on ej.experience_notice_id=e.id
        left join tbl_job_category j on j.id=ej.job_category
        left join tbl_save_experience_notice sv on e.id = sv.experience_notice_id
        where e.experience_request_status='accept'
        and e.experience_end_date &gt;= now()
        and e.experience_notice_status='active'
        <include refid="search"></include>
        group by e.id,
                 e.experience_notice_title,
                 e.experience_notice_subtitle,
                 e.experience_notice_etc,
                 e.experience_start_date,
                 e.experience_end_date,
                 e.experience_notice_status,
                 e.created_datetime,
                 e.updated_datetime,
                 e.company_id,
                 c.company_name,
                 s.id,
                 s.company_scale_name,
                 j.job_name;
    </select>
<!--    전체 개수 조회-->
    <select id="selectCountAll">
        select count(*) from tbl_experience_notice
        where experience_request_status='accept'
        and experience_notice_status='active'
    </select>
<!--    체험 공고 단일 조회-->
    <select id="selectById">
        select id, experience_notice_title, experience_notice_subtitle, experience_notice_introduce_job, experience_notice_etc, experience_start_date, experience_end_date, experience_notice_status, created_datetime, updated_datetime, company_id
        from tbl_experience_notice
        where id=#{id}
        and experience_request_status='accept'
        and experience_notice_status='active'
    </select>
<!--    직군 조회-->
    <select id="selectJobNameByExpId">
        select j.job_name
        from tbl_job_category j
        join tbl_experience_job_category ej
        on ej.job_category=j.id
        join tbl_experience_notice e
        on e.id=ej.experience_notice_id
        where ej.experience_notice_id=#{id}
    </select>
</mapper>