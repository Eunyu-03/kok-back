<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.kok.mapper.MemberMapper">
    <insert id="insertMember">
        insert into tbl_member(user_id,member_provider,member_profile_url)
        values(#{userId},#{memberProvider},#{memberProfileUrl})
    </insert>

    <sql id="search">
        <if test="keyword != null and keyword != ''">
            and (
            user_name like concat('%', #{keyword}, '%') or
            user_email like concat('%', #{keyword}, '%') or
            job_name like concat('%', #{keyword}, '%')
            )
        </if>
    </sql>

<!-- 일반 회원 전체 조회 -->
    <select id="selectMembers">
        select id, user_name, user_phone, user_email, user_role, sns_email, user_status, member_profile_url, avg_score, job_name
        from view_user_with_evaluation_and_job
        where user_status = 'active' and user_role = 'member'
        <include refid="search"/>
        order by id desc
        limit #{criteria.count} offset #{criteria.offset}
    </select>

<!--  목록 개수  -->
    <select id="selectCount">
        select count(*)
        from view_user_with_evaluation_and_job
        where user_status = 'active' and user_role = 'member'
        <include refid="search"/>
    </select>

<!-- 회원 아이디로 조회 -->
<select id="selectMember">
    select id, user_name, user_phone, user_email, user_role, sns_email, user_status, member_profile_url, avg_score, job_name
    from view_user_with_evaluation_and_job
    where user_status = 'active' and user_role = 'member' and id = #{id}
</select>

<!--    회원 id로 지원한 체험 공고 목록 조회-->
    <select id="selectExperienceByMemberId">
        select r.id, r.member_id, c.company_name, e.experience_notice_title, r.request_experience_status
        from tbl_user u
        join tbl_request_experience r
        on r.member_id=u.id
        join tbl_experience_notice e
        on e.id=r.experience_notice_id
        join tbl_company c
        on c.user_id=e.company_id
        where u.id=#{memberId}
    </select>
    <!--    회원 id로 지원한 인턴 공고 목록 조회-->
    <select id="selectInternByMemberId">
        select r.id, r.member_id, c.company_name, i.intern_notice_title, r.request_intern_status
        from tbl_user u
        join tbl_request_intern r
        on r.member_id=u.id
        join tbl_intern_notice i
        on i.id=r.intern_notice_id
        join tbl_company c
        on c.user_id=i.company_id
        where u.id=#{memberId}
    </select>

<!--    평점 평균 조회-->
    <select id="selectAvgByMemberId">
        select avg
        from view_member_with_evaluation
        where member_id=#{memberId}
    </select>
<!--  전화번호로 회원 sns이메일 조회  -->
    <select id="selectLinkBYPhone">
        select u.sns_email, m.member_provider from tbl_user u join tbl_member m
        on u.id= m.user_id
        where u.user_phone = #{userPhone} and u.user_status = 'active' and m.member_provider != 'kok'
        order by m.member_provider DESC

    </select>
</mapper>